---
classes:
  - elasticsearch
  - apache
  - apache::mod::authnz_ldap
  - apache::mod::ext_filter
  - apache::mod::headers
  - apache::mod::proxy
  - apache::mod::proxy_http
  - apache::mod::rewrite
  - blocky_server
  - datadog_agent::integrations::elasticsearch
  - oraclejava::install
  - ssl::name::wildcard_apache_org
  - vhosts_asf::modules
  - vhosts_asf::vhosts
  - webstats

backuppc::client::backup_files_exclude:
  - /proc
  - /sys
  - /dev
  - /x1
  - /var/log/elasticsearch

base::basepackages:
  - 'lua5.2'
  - 'liblua5.2-dev'
  - 'lua5.2-cjson'
  - 'lua5.2-socket'
  - 'lua5.2-sec'

vhosts_asf::modules::modules:
  allowmethods:
    name: 'allowmethods'
  lua:
    name: 'lua'

datadog_agent::integrations::elasticsearch::url: 'http://localhost:9200'

dnsclient::nameservers:
  - '213.133.100.100'
  - '213.133.98.98'
  - '213.133.99.99'
  - '2a01:4f8:0:a102::add:9999'
  - '2a01:4f8:0:a111::add:9898'
  - '2a01:4f8:0:a0a1::add:1010'

elasticsearch::init_defaults:
  DATA_DIR: '/x1/elastic/db/'
elasticsearch::jvm_options:
  - '-Xms30g'
  - '-Xmx30g'
elasticsearch::java_install: true
elasticsearch::version: '5.6.11'
elasticsearch::ensure: 'present'
elasticsearch::status: 'enabled'
elasticsearch::default_logging_level: 'WARN'
elasticsearch::instances:
  asful:
    datadir: '/x1/elastic/db/'
    config:
      node.name: 'logging1-he-fi'
      discovery.zen.minimum_master_nodes: '2'
      network.host: '0.0.0.0'
      discovery.zen.ping.unicast.hosts:
        - 95.216.25.231
        - 95.216.25.232

apache::default_vhost: false
apache::default_ssl_cert:                    '/etc/ssl/certs/wildcard.apache.org.crt'
apache::default_ssl_chain:                   '/etc/ssl/certs/wildcard.apache.org.chain'
apache::default_ssl_key:                     '/etc/ssl/private/wildcard.apache.org.key'

apache::mpm_module:         'event'

apache::mod::event::listenbacklog: '511'
apache::mod::event::maxclients: '3000'
apache::mod::event::maxconnectionsperchild: '20000'
apache::mod::event::maxrequestworkers: '3000'
apache::mod::event::maxsparethreads: '1500'
apache::mod::event::minsparethreads: '300'
apache::mod::event::serverlimit: '20'
apache::mod::event::startservers: '8'
apache::mod::event::threadlimit: '3000'
apache::mod::event::threadsperchild: '300'

# Hermes etc needs old-skool stuff still
apache::mod::ssl::ssl_cipher: 'HIGH:MEDIUM:!aNULL:!MD5:!RC4'
apache::mod::ssl::ssl_protocol: ['all', '-SSLv2', '-SSLv3']

cron:
  # Curator cron for keeping disk space happy
  curator:
    user: 'root'
    minute: [0]
    hour: '2'
    command: 'cd /root/ && python3 curator.py'
  fingerprints:
    user: 'root'
    minute: [0]
    hour: '*'
    command: 'cd /var/www/ && python fps.py > /var/www/snappy/fingerprints.html'
  fingerprintsraw:
    user: 'root'
    minute: [5]
    hour: '*'
    command: 'cd /var/www/ && python fps.py raw > /var/www/snappy/fingerprints_raw.html'

loggy::service_ensure: 'stopped'

logrotate::rule:
  apache2:
    ensure: 'present'


vhosts_asf::vhosts::vhosts:
  es1-eu-mid-ssl:
    vhost_name: '*'
    ensure: 'present'
    port: 443
    ssl: true
    servername: 'es1-eu-mid.apache.org'
    serveradmin: 'webmaster@apache.org'
    docroot: '/var/www/snappy/'
    access_log_file: '/dev/null'
    error_log_file: 'es1-eu-mid.apache.org.error.log'
    custom_fragment: |
      <Location /logstash/%{hiera('loggy::route')}/>
          AllowMethods POST PUT HEAD
          <If "%%{HIERA}{REQUEST_METHOD} in { 'GET', 'DELETE' }">
            Require ip 80.62.116.202 95.217.4.16 95.217.212.187 \
              34.75.233.178 35.227.186.76 35.197.111.126 34.71.105.110 35.225.18.242 34.122.105.195 35.202.76.74 34.121.74.236 \
              35.224.199.71 34.123.137.154 34.123.52.190 34.66.49.190 35.222.121.249 35.223.207.201 34.70.174.12 34.72.147.218 \
              35.226.219.105 35.238.231.51 34.66.56.141 34.121.193.43 34.121.32.138 34.68.220.254 35.225.105.116 35.192.52.169 \
              35.224.156.39 35.224.91.160 34.67.43.62 34.71.159.145 35.222.54.147 34.67.160.129 34.122.175.63 35.224.1.28 \
              34.69.65.175 34.72.163.126 34.123.65.205 35.192.14.84 35.188.116.92 34.121.131.55 35.188.223.169 34.122.222.178 \
              34.121.197.22 35.238.168.12 34.123.216.236 34.70.43.156 34.121.201.223 35.188.20.238 34.72.224.67 104.155.177.193 \
              35.184.97.84 34.122.31.64 35.202.40.138 34.71.97.66 146.148.50.186 35.192.150.184 35.239.94.5 35.238.166.119 \
              34.122.39.130 34.122.217.27 34.69.240.57 35.184.3.239 34.72.77.151 104.154.73.15 34.123.43.73 34.66.14.141 \
              35.184.89.210 34.71.245.127 35.193.5.35 35.222.83.115 35.184.82.156 104.154.18.168 34.122.170.239 35.223.104.30 \
              34.69.83.169 104.154.215.108 34.123.204.135 35.223.107.0 104.198.65.151 35.226.77.201 34.66.116.195 34.67.99.68 \
              34.68.83.43 35.232.69.80 104.197.50.166 35.239.129.198 34.70.10.78 35.226.135.153 104.154.186.57 34.69.61.176 \
              108.59.81.93 107.178.208.235 35.223.253.104 35.226.44.6 34.66.11.191 34.69.204.106 34.122.248.104 35.222.32.135 \
              35.224.241.132 34.71.215.109 34.122.152.60 35.192.170.84 35.226.82.155 35.232.163.40 108.59.86.147 34.72.238.245 \
              23.251.149.189 34.70.247.232 35.238.37.45 35.232.31.131 104.197.153.96 34.69.93.206 35.202.156.31 34.68.238.149 \
              34.71.246.22 34.122.201.10 34.68.195.121 35.222.47.158 35.232.72.188 35.239.228.168 104.155.148.240 35.194.53.190 \
              34.66.135.187 34.66.82.105 34.69.204.49 35.232.165.163 35.193.142.43 35.195.32.148 35.240.3.33 146.148.114.193 \
              35.205.153.2 52.189.69.217
            Require all denied
          </If>
          ProxyPass http://localhost:9200/
      </Location>
  uls-ssl:
    vhost_name: '*'
    ensure: 'present'
    port: 443
    ssl: true
    servername: 'uls.apache.org'
    serveradmin: 'webmaster@apache.org'
    docroot: '/var/www/snappy/'
    access_log_file: 'uls.apache.org.ssl_access.log'
    error_log_file: 'uls.apache.org.error.log'
    custom_fragment: |
      Header set Access-Control-Allow-Origin "*"
      Header set Access-Control-Allow-Methods "POST, GET, OPTIONS"
      Header set Access-Control-Allow-Headers "X-PINGOTHER"
      Header set Access-Control-Max-Age "1728000"
      Alias /json/ /var/www/html/json/
      <Directory /var/www/html>
        Require all granted
        Options +Indexes
      </Directory>
      LuaScope thread
      LuaCodeCache stat
      AddHandler lua-script .lua
      
      # Everything else is authed off
      <LocationMatch ^/((app|ui|bundles|api|plugins|es_admin|elasticsearch)/.*)$>
          AuthLDAPUrl "ldaps://ldap-eu-ro.apache.org/ou=people,dc=apache,dc=org?uid"
          AuthLDAPRemoteUserAttribute member
          AuthName "ASF Infrastructure-root/logging Only"
          AuthType Basic
          AuthBasicProvider ldap
          AuthLDAPGroupAttributeIsDN on
          <RequireAny>
            Require ldap-group cn=infrastructure-root,ou=groups,ou=services,dc=apache,dc=org
            Require ldap-group cn=infrastructure-logging,ou=groups,ou=services,dc=apache,dc=org
          </RequireAny>
          ProxyPass http://127.0.0.1:5602/$1
      </LocationMatch>
